---
# Dynamically create vhosts and databases using the inventory for this box.
#
# Apache vhosts are created using all hostnames for this box, setting the
# docroot to the host's "documentroot_dir" variable. MySQL databases, users,
# and passwords are created using the "dbname" variable.
#
# IMPORTANT! This assumes repositories_dir, documentroot_subdir, and dbname are defiend for each host's vars.
#

- name: Copy dashboard page into place.
  template:
    src: "{{ dashboard_template_dir }}/dashboard.html.j2"
    dest: "{{ dashboard_install_dir }}/index.html"
    mode: 0644
    owner: "{{ drupalvm_user }}"
    group: "{{ drupalvm_user }}"

- name: Create private files directory
  file:
    path: "{{ drupal_composer_install_dir }}/files/private"
    state: directory
    mode: 0755
    owner: "{{ drupalvm_user }}"
    group: "{{ drupalvm_user }}"

- name: Include vars of config yaml file into vm_config
  include_vars:
    file: "../config.yml"
    name: vm_config

- name: Populate mysql_databases variable
  set_fact:
    mysql_databases: "{{ mysql_databases + [{
      'name': item.key,
      'encoding': 'utf8mb4',
      'collation': 'utf8mb4_general_ci'
    }] }}"
  with_dict: "{{ vm_config['robertshell_sites'] }}"

- name: Populate mysql_users variable
  set_fact:
    mysql_users: "{{ mysql_users + [{
      'name': item.key,
      'host': '%',
      'password': item.key,
      'priv': item.key + '.*:ALL'
    }] }}"
  with_dict: "{{ vm_config['robertshell_sites'] }}"

- name: Create private files directory
  file:
    path: "{{ drupal_composer_install_dir }}/files/private/{{ item.key }}"
    state: directory
    mode: 0755
    owner: "{{ drupalvm_user }}"
    group: "{{ drupalvm_user }}"
  with_dict: "{{ vm_config['robertshell_sites'] }}"